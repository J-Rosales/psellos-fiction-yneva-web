# Data and Query Specification

## 1. Objective

Define finalized data contracts and read-only query behavior for presentation features, including mandatory narrative-layer filtering across graph, map, and index/query surfaces.

## 2. Scope and Consumers

- Primary purpose: power interactive UX (search, graph, map) with reliable query semantics.
- Primary consumer: this web frontend.
- External client support is a future feature and is enabled only after stability gates are met.

Stability gates for external support:
- endpoint behavior stable across two release cycles,
- error shape locked,
- query semantics documented,
- regression suite in CI for core endpoints.

## 3. Governance and Boundaries

- Input comes only from compiled artifacts generated by `psellos-builder`.
- No runtime reads of raw YAML/spec files.
- This layer is read-only for canon.
- Limited business interpretation is allowed for search/ranking/clustering, but canonical authority remains upstream.

## 4. Contract Strategy

- Validation mode: strict validation for required fields.
- Unknown/future fields: ignored for core logic and logged as warnings in ingest/query metadata.
- API lifecycle: frontend-internal first, lightweight endpoint documentation first, OpenAPI formalization later.
- Versioning: unversioned until first breaking change, then introduce explicit versioning.

## 5. Layer Filter Semantics

- `layer` is accepted on all relevant query surfaces.
- If absent, `layer` defaults to `canon`.
- Layer filtering is hard-filter semantics: only records in the selected layer are returned.
- Unknown layer returns an empty result with warning metadata.
- Multi-layer compare is handled by dedicated compare endpoints only.

## 6. Search and Ranking Semantics

- Default mode: fuzzy search.
- Exact mode: global toggle available across the app.
- Ranking priority: text relevance first.
- Tie-break behavior: deterministic stable ordering (display name, then id).
- Query parsing: forgiving (typos/partial tokens).
- `rel_type` acts as hard include/exclude filter, not a soft boost.
- Unknown/ambiguous semantics are returned as explicit buckets where applicable, not silently dropped.

## 7. Graph Query Semantics

- Deep traversal is available by default.
- Client-driven expansion: client may fetch broad graph data and compute additional expansions locally.
- Rendering target: best-effort full graph rendering for available data.
- Expansion ordering: highest-confidence edges first.
- Cluster model: scored/probabilistic clustering with weighted signals.
- `View *` cluster modes (for example `View Dynasty`, `View Workplace`) are inference modes using a ruleset built only from assertions and relations.
- Cluster overlap: multi-membership allowed.
- Cluster precedence: user-selectable in Advanced options.

## 8. Map Query and Spatial Model

- Discovery orientation: place-first.
- Result grouping: place, then related entities.
- Spatial framing model: Earth-like geodetic behavior with scale modifier support (planet radius/diameter).
- Initial map delivery uses feature/vector responses; no tile pipeline in initial release.
- PostGIS is optional and adopted only after compatibility is validated against the scale-modifier model.

## 9. Database and Indexing Direction

- Database: PostgreSQL.
- PostGIS: conditional adoption, not baseline.
- Indexing cadence: batch rebuild on artifact publish.
- Search indexing: database-native indexing first.
- Database role: disposable read-only index; artifacts remain source of truth.

## 10. API Shape

Baseline endpoint style is resource-oriented HTTP:
- `GET /api/entities`
- `GET /api/entities/:id`
- `GET /api/assertions`
- `GET /api/graph/neighborhood`
- `GET /api/map/features`
- `GET /api/layers`
- `GET /api/layers/:id/changelog?base=canon`

Common filters where relevant:
- `layer`
- `q`
- `rel_type`
- `entity_type`
- `date_from`
- `date_to`
- route-specific graph/map controls

## 11. Error and Observability Policy

- Initial error model is intentionally minimal and consistent.
- Baseline error payload fields:
  - `status`
  - `message`
  - `request_id`
  - optional `layer`
- Observability baseline: basic logs and latency metrics.
- Audit metadata is optional in initial rollout.

## 12. Testing Priority

- First priority: end-to-end UI scenarios.
- Next priority: contract tests and layer-invariant tests.
- Regression suites are required before promoting the API beyond frontend-internal use.

## 13. Source Notes

External references used for API viability orientation:
- WHG API docs: `https://docs.whgazetteer.org/content/technical/apis.html`
- WHG platform overview: `https://www.whgazetteer.org/`
- APIS framework description (REST mention): `https://pypi.org/project/apis-core-rdf/`
